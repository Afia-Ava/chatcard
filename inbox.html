<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Request Card | Sunpost</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="login.css" />
    <style>
      html,
      body {
        background: #f5f1ea !important;
        color: #3c2f2f;
        min-height: 100vh;
        font-family: 'Georgia', 'Poppins', 'Inter', serif;
      }
      aside {
        background: #a8bba3 !important;
        border-right: 4px solid #cbbfad;
        box-shadow: none !important;
      }
      .sidebar-link {
        color: #3c2f2f !important;
        background: #e9e5dc !important;
        border-radius: 8px;
        margin-bottom: 2px;
        font-weight: 600;
        transition: background 0.18s;
      }
      .sidebar-link.selected,
      .sidebar-link:hover {
        background: #cbbfad !important;
        color: #3c2f2f !important;
      }
      #sidebar-profile-pic {
        border: 2.5px solid #cbbfad;
        box-shadow: 0 2px 8px #cbbfad44;
      }
      #sidebar-profile-name {
        color: #3c2f2f !important;
      }
      #profile-dropdown {
        background: #e9e5dc !important;
        border: 1.5px solid #cbbfad;
        color: #3c2f2f !important;
      }
      #main-content {
        background: #f5f1ea !important;
        border-radius: 18px;
        box-shadow: none !important;
        margin: 0;
        padding: 0;
        border: none;
      }
      h2 {
        color: #3c2f2f !important;
        font-family: 'Georgia', serif;
        letter-spacing: 0.01em;
      }
      label,
      p,
      span,
      input,
      textarea,
      button {
        color: #3c2f2f !important;
        font-family: 'Georgia', 'Poppins', serif;
      }
      textarea,
      input {
        background: #e9e5dc !important;
        border: 1.5px solid #cbbfad;
        color: #3c2f2f !important;
        font-size: 1rem;
      }
      button {
        background: #a8bba3 !important;
        color: #3c2f2f !important;
        border: 1.5px solid #cbbfad;
        border-radius: 8px;
        font-weight: 700;
        font-family: 'Georgia', 'Poppins', serif;
        box-shadow: 0 1px 4px #cbbfad33;
        transition: background 0.18s;
      }
      button:hover {
        background: #cbbfad !important;
      }
    </style>
  </head>
  <body>
    <div style="height: 120px"></div>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
      const script = document.createElement('script');
      script.src = 'firebase-secrets.js';
      script.onload = function () {
        firebase.initializeApp(window.firebaseConfig);
        window.db = firebase.firestore();
      };
      document.head.appendChild(script);
    </script>
    <main style="display: flex; min-height: 100vh; background: #f5f1ea">
      <aside
        style="
          width: 260px;
          min-height: 100vh;
          height: 100vh;
          border-radius: 0;
          margin: 0;
          position: fixed;
          top: 0;
          left: 0;
          z-index: 2;
          display: flex;
          flex-direction: column;
          align-items: center;
          background: #a8bba3 !important;
          border-right: 4px solid #cbbfad;
          box-shadow: 2px 0 12px #a8bba344;
        "
      >
        <div
          style="
            width: 100%;
            padding: 36px 0 18px 0;
            display: flex;
            justify-content: flex-start;
            align-items: center;
          "
        >
          <span
            style="
              font-family: 'Georgia', 'Poppins', serif;
              font-size: 2.1rem;
              font-weight: 700;
              color: #3c2f2f;
              letter-spacing: 0.5px;
              margin-left: 16px;
              text-shadow: none;
            "
            >sunpost</span
          >
        </div>
        <nav
          style="
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: 12px;
            gap: 6px;
            padding-left: 12px;
          "
        >
          <a
            href="write.html"
            class="sidebar-link left-nav-link"
            id="write-link"
            >Write</a
          >
          <a
            href="inbox.html"
            class="sidebar-link left-nav-link selected"
            id="inbox-link"
            >Inbox</a
          >
          <a
            href="archive.html"
            class="sidebar-link left-nav-link"
            id="archive-link"
            >Archive</a
          >
        </nav>
        <div style="flex: 1"></div>
        <div
          style="
            width: 100%;
            padding: 0 0 24px 0;
            display: flex;
            justify-content: center;
            align-items: flex-end;
          "
        >
          <div
            style="
              display: flex;
              align-items: center;
              width: 90%;
              background: none;
              border-radius: 0;
              padding: 0;
              gap: 12px;
              box-shadow: none;
            "
          >
            <img
              id="sidebar-profile-pic"
              src="https://images.unsplash.com/photo-1518717758536-85ae29035b6d?auto=format&fit=facearea&w=256&h=256&facepad=2"
              alt="Profile Picture"
              style="
                width: 38px;
                height: 38px;
                border-radius: 50%;
                object-fit: cover;
              "
            />
            <span
              id="sidebar-profile-name"
              style="
                color: #3c2f2f;
                font-size: 1.08rem;
                font-weight: 500;
                white-space: nowrap;
              "
              >Your Name</span
            >
            <script>
              document.addEventListener('DOMContentLoaded', function () {
                var sidebarPic = document.getElementById('sidebar-profile-pic');
                var savedPic = localStorage.getItem('sunpost_profile_pic');
                if (sidebarPic && savedPic) sidebarPic.src = savedPic;
                var sidebarName = document.getElementById(
                  'sidebar-profile-name'
                );
                var savedName = localStorage.getItem('sunpost_profile_name');
                var savedEmail = localStorage.getItem('sunpost_profile_email');
                if (sidebarName) {
                  if (savedName && savedName.trim()) {
                    sidebarName.textContent = savedName;
                  } else if (savedEmail && savedEmail.trim()) {
                    sidebarName.textContent = savedEmail.split('@')[0];
                  } else {
                    sidebarName.textContent = 'Your Name';
                  }
                }
              });
            </script>
            <span style="margin-left: auto; display: flex; align-items: center">
              <div style="position: relative">
                <button
                  id="profile-menu-btn"
                  style="
                    background: none;
                    border: none;
                    padding: 0;
                    cursor: pointer;
                  "
                >
                  <svg
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#3c5c3c"
                    stroke-width="2.1"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="6" r="1.5" fill="#3c5c3c" />
                    <circle cx="12" cy="12" r="1.5" fill="#3c5c3c" />
                    <circle cx="12" cy="18" r="1.5" fill="#3c5c3c" />
                  </svg>
                </button>
                <div
                  id="profile-dropdown"
                  style="
                    display: none;
                    position: absolute;
                    right: 0;
                    bottom: 38px;
                    background: #e9e5dc;
                    border-radius: 8px;
                    box-shadow: 0 2px 12px #cbbfad33;
                    min-width: 140px;
                    z-index: 10;
                  "
                >
                  <a
                    href="settings.html"
                    id="settings-link"
                    style="
                      display: block;
                      padding: 12px 18px;
                      color: #3c2f2f;
                      text-decoration: none;
                      font-size: 1em;
                      border-bottom: 1px solid #333;
                      border-radius: 8px 8px 0 0;
                      font-weight: 600;
                    "
                    >Settings</a
                  >
                  <a
                    href="index.html"
                    id="logout-link"
                    style="
                      display: block;
                      padding: 12px 18px;
                      color: #3c2f2f;
                      text-decoration: none;
                      font-size: 1em;
                      border-radius: 0 0 8px 8px;
                      font-weight: 600;
                    "
                    >Log Out</a
                  >
                </div>
              </div>
              <script>
                document.addEventListener('DOMContentLoaded', function () {
                  var sidebarPic = document.getElementById(
                    'sidebar-profile-pic'
                  );
                  var savedPic = localStorage.getItem('sunpost_profile_pic');
                  if (sidebarPic && savedPic) {
                    sidebarPic.src = savedPic;
                  }
                });
                const menuBtn = document.getElementById('profile-menu-btn');
                const dropdown = document.getElementById('profile-dropdown');
                if (menuBtn && dropdown) {
                  menuBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    dropdown.style.display =
                      dropdown.style.display === 'block' ? 'none' : 'block';
                  });
                  document.addEventListener('click', function (e) {
                    if (dropdown.style.display === 'block')
                      dropdown.style.display = 'none';
                  });
                }
              </script>
            </span>
          </div>
        </div>
      </aside>
      <section
        id="main-content"
        style="flex: 1; min-height: 60vh; margin-left: 260px; padding: 0"
      >
        <div id="inbox-content" style="margin: 0 0 0 48px; max-width: 900px">
          <h2
            style="
              font-size: 1.5rem;
              font-weight: 700;
              margin-bottom: 10px;
              color: #3c2f2f;
            "
          >
            Inbox
          </h2>
          <div
            style="
              margin-bottom: 38px;
              color: #3c2f2f;
              font-size: 1.08rem;
              font-family: 'Georgia', 'Poppins', serif;
            "
          >
            You’ve got mail, little letters that found their way to you.<br />
          </div>
          <div
            id="inbox-list"
            style="
              min-height: 120px;
              color: #3c2f2f;
              font-size: 1.01rem;
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 28px 22px;
              max-width: 1100px;
              margin-bottom: 60px;
              box-sizing: border-box;
              padding-right: 18px;
              margin-left: 0;
              margin-right: 0;
            "
          >
            <div
              id="inbox-empty"
              style="
                background: #e9e5dc;
                border-radius: 16px;
                box-shadow: 0 1px 12px #cbbfad33;
                padding: 32px 48px;
                margin-top: 64px;
                margin-bottom: 18px;
                text-align: center;
                color: #3c2f2f;
                width: 100%;
                max-width: calc(100vw - 280px);
                min-width: 320px;
                box-sizing: border-box;
                align-self: center;
                font-size: 1.13rem;
                font-family: 'Georgia', 'Poppins', serif;
              "
            >
              It’s quiet here for now.<br />
            </div>
            <div
          </div>
          <script>
            document.addEventListener('DOMContentLoaded', function () {
              function showLetterModal(letter) {
                var modal = document.getElementById('inbox-modal');
                if (!modal) {
                  modal = document.createElement('div');
                  modal.id = 'inbox-modal';
                  modal.style.position = 'fixed';
                  modal.style.top = '0';
                  modal.style.left = '0';
                  modal.style.width = '100vw';
                  modal.style.height = '100vh';
                  modal.style.background = 'rgba(245,241,234,0.96)';
                  modal.style.zIndex = '1000';
                  modal.style.display = 'flex';
                  modal.style.justifyContent = 'center';
                  modal.style.alignItems = 'center';
                  var modalContent = document.createElement('div');
                  modalContent.id = 'inbox-modal-content';
                  modalContent.style.background = '#e9e5dc';
                  modalContent.style.borderRadius = '18px';
                  modalContent.style.boxShadow = '0 2px 24px #cbbfad55';
                  modalContent.style.padding = '54px 48px';
                  modalContent.style.width = '100%';
                  modalContent.style.maxWidth = '820px';
                  modalContent.style.minWidth = '480px';
                  modalContent.style.maxHeight = '80vh';
                  modalContent.style.overflowY = 'auto';
                  modalContent.style.color = '#3c2f2f';
                  modalContent.style.fontFamily = "'Georgia', 'Poppins', serif";
                  modalContent.style.position = 'relative';
                  modal.appendChild(modalContent);
                  document.body.appendChild(modal);
                }
                var modalContent = document.getElementById(
                  'inbox-modal-content'
                );
                modalContent.style.width = '100%';
                modalContent.style.maxWidth = '820px';
                modalContent.style.minWidth = '480px';
                modalContent.style.maxHeight = '80vh';
                modalContent.style.overflowY = 'auto';
                modalContent.style.padding = '54px 48px';
                modalContent.innerHTML =
                  '<button id="close-inbox-modal-btn" style="position:absolute;top:18px;right:18px;background:#a8bba3;color:#3c2f2f;border:1.5px solid #cbbfad;border-radius:6px;font-weight:700;font-size:1.1rem;padding:4px 12px;cursor:pointer;">Close</button>' +
                  '<div style="font-weight:700; margin-bottom:8px; color:#3c2f2f;">From: ' +
                  (letter.from || 'Anonymous') +
                  (letter.fromEmail
                    ? ' &lt;' + letter.fromEmail + '&gt;'
                    : '') +
                  '</div>' +
                  '<div style="margin-bottom:10px; color:#3c2f2f; white-space:pre-line;">' +
                  (letter.content || '') +
                  '</div>' +
                  '<div style="font-size:0.98rem; color:#a8bba3;">Sent: ' +
                  (letter.sentAt
                    ? new Date(letter.sentAt).toLocaleString()
                    : '') +
                  '</div>';
                modal.style.display = 'flex';
                document.getElementById('close-inbox-modal-btn').onclick =
                  function () {
                    modal.style.display = 'none';
                  };
                modal.onclick = function (e) {
                  if (e.target === modal) modal.style.display = 'none';
                };
              }

              function showPasswordPrompt(letter) {
                var promptModal = document.getElementById(
                  'inbox-password-modal'
                );
                if (!promptModal) {
                  promptModal = document.createElement('div');
                  promptModal.id = 'inbox-password-modal';
                  promptModal.style.position = 'fixed';
                  promptModal.style.top = '0';
                  promptModal.style.left = '0';
                  promptModal.style.width = '100vw';
                  promptModal.style.height = '100vh';
                  promptModal.style.background = 'rgba(245,241,234,0.96)';
                  promptModal.style.zIndex = '2000';
                  promptModal.style.display = 'flex';
                  promptModal.style.justifyContent = 'center';
                  promptModal.style.alignItems = 'center';
                  var promptContent = document.createElement('div');
                  promptContent.id = 'inbox-password-modal-content';
                  promptContent.style.background = '#e9e5dc';
                  promptContent.style.borderRadius = '18px';
                  promptContent.style.boxShadow = '0 2px 24px #cbbfad55';
                  promptContent.style.padding = '64px 48px 38px 48px';
                  promptContent.style.maxWidth = '600px';
                  promptContent.style.minWidth = '380px';
                  promptContent.style.color = '#3c2f2f';
                  promptContent.style.fontFamily =
                    "'Georgia', 'Poppins', serif";
                  promptContent.style.position = 'relative';
                  promptModal.appendChild(promptContent);
                  document.body.appendChild(promptModal);
                }
                var promptContent = document.getElementById(
                  'inbox-password-modal-content'
                );
                promptContent.innerHTML =
                  '<button id="close-inbox-password-modal-btn" style="position:absolute;top:18px;right:18px;background:#a8bba3;color:#3c2f2f;border:1.5px solid #cbbfad;border-radius:6px;font-weight:700;font-size:1.1rem;padding:4px 12px;cursor:pointer;">Close</button>' +
                  '<div style="font-weight:700; margin-bottom:18px; color:#3c2f2f; font-size:1.15rem;">Enter your account password</div>' +
                  '<input id="inbox-password-input" type="password" placeholder="Password" style="width:100%;margin-bottom:16px;padding:10px 12px;border-radius:6px;border:1.5px solid #cbbfad;font-size:1.08rem;background:#f5f1ea;color:#3c2f2f;outline:none;">' +
                  '<div id="inbox-password-error" style="color:#b44a4a;font-size:0.98rem;margin-bottom:10px;display:none;"></div>' +
                  '<button id="inbox-password-submit" style="background:#a8bba3;color:#3c2f2f;border:1.5px solid #cbbfad;border-radius:8px;padding:10px 18px;font-size:1rem;font-weight:600;cursor:pointer;width:100%;">Submit</button>';
                promptModal.style.display = 'flex';
                document.getElementById(
                  'close-inbox-password-modal-btn'
                ).onclick = function () {
                  promptModal.style.display = 'none';
                };
                promptModal.onclick = function (e) {
                  if (e.target === promptModal)
                    promptModal.style.display = 'none';
                };
                document.getElementById('inbox-password-submit').onclick =
                  function () {
                    var input = document.getElementById(
                      'inbox-password-input'
                    ).value;
                    var errorDiv = document.getElementById(
                      'inbox-password-error'
                    );
                    var email = localStorage.getItem('sunpost_profile_email');
                    if (!email || !email.trim()) {
                      errorDiv.textContent = 'No account email found.';
                      errorDiv.style.display = 'block';
                      return;
                    }
                    if (!window.firebase || !window.firebase.auth) {
                      errorDiv.textContent = 'Auth not loaded.';
                      errorDiv.style.display = 'block';
                      return;
                    }
                    window.firebase
                      .auth()
                      .signInWithEmailAndPassword(email, input)
                      .then(function (userCredential) {
                        promptModal.style.display = 'none';
                        setTimeout(function () {
                          showLetterModal(letter);
                        }, 100);
                      })
                      .catch(function (error) {
                        errorDiv.textContent = 'Incorrect password.';
                        errorDiv.style.display = 'block';
                      });
                  };
                document.getElementById('inbox-password-input').onkeydown =
                  function (e) {
                    if (e.key === 'Enter')
                      document.getElementById('inbox-password-submit').click();
                  };
              }

              function loadInbox() {
                var userEmail = localStorage.getItem('sunpost_profile_email');
                var inboxList = document.getElementById('inbox-list');
                var inboxEmpty = document.getElementById('inbox-empty');
                var inboxCards = inboxList.querySelectorAll(
                  'div:not(#inbox-empty):not(#letter-modal)'
                );
                inboxCards.forEach(function (card) {
                  card.remove();
                });
                var oldSpacer = document.getElementById('inbox-spacer');
                if (oldSpacer) oldSpacer.remove();
                inboxEmpty.style.display = 'none';
                if (!userEmail || !userEmail.trim()) {
                  inboxEmpty.style.display = 'block';
                  inboxEmpty.innerHTML = 'You are not logged in.';
                  return;
                }
                userEmail = userEmail.trim().toLowerCase();
                var query = db
                  .collection('letters')
                  .where('to', '==', userEmail);
                query
                  .orderBy('sentAt', 'desc')
                  .get()
                  .then(function (querySnapshot) {
                    var found = 0;
                    if (querySnapshot.empty) {
                      inboxEmpty.style.display = 'block';
                      inboxEmpty.innerHTML =
                        'It\'s quiet here for now.<br><span style="color:#a8bba3; font-size:0.95em;">(No letters found for ' +
                        userEmail +
                        ')</span>';
                    } else {
                      querySnapshot.forEach(function (doc) {
                        var letter = doc.data();
                        found++;
                        var card = document.createElement('div');
                        card.style.background = '#e9e5dc';
                        card.style.borderRadius = '12px';
                        card.style.boxShadow = '0 1px 6px #cbbfad33';
                        card.style.padding = '22px 18px';
                        card.style.fontFamily = "'Georgia', 'Poppins', serif";
                        card.style.background = '#e9e5dc';
                        card.style.borderRadius = '12px';
                        card.style.boxShadow = '0 1px 6px #cbbfad33';
                        card.style.maxWidth = '320px';
                        card.style.width = '320px';
                        card.style.maxWidth = '320px';
                        card.style.minWidth = '320px';
                        card.style.height = '180px';
                        card.style.boxSizing = 'border-box';
                        card.style.display = 'flex';
                        card.style.flexDirection = 'column';
                        card.style.justifyContent = 'space-between';
                        card.style.padding = '22px 18px';
                        card.style.fontFamily = "'Georgia', 'Poppins', serif";
                        card.innerHTML =
                          '<span style="font-size:1.08rem;color:#3c2f2f;margin-bottom:10px;display:block;"><b>From: ' +
                          (letter.from || 'Anonymous') +
                          (letter.fromEmail
                            ? ' &lt;' + letter.fromEmail + '&gt;'
                            : '') +
                          '</b></span>' +
                          '<span style="color:#a8bba3;font-size:0.95rem;">Date: ' +
                          (letter.sentAt
                            ? new Date(letter.sentAt).toLocaleString()
                            : '') +
                          '</span><br />' +
                          '<button class="inbox-view-btn" style="background:#a8bba3;color:#3c2f2f;border:1.5px solid #cbbfad;border-radius:8px;padding:10px 18px;font-size:1rem;font-weight:600;cursor:pointer;margin-top:10px;float:right;">View</button>';
                        inboxList.appendChild(card);
                        card
                          .querySelector('.inbox-view-btn')
                          .addEventListener('click', function (e) {
                            e.stopPropagation();
                            showPasswordPrompt(letter);
                          });
                      });
                      if (found === 0) {
                        inboxEmpty.style.display = 'block';
                        inboxEmpty.innerHTML =
                          'It\'s quiet here for now.<br><span style="color:#a8bba3; font-size:0.95em;">(No letters found for ' +
                          userEmail +
                          ')</span>';
                      } else {
                        inboxEmpty.style.display = 'none';
                        var spacer = document.createElement('div');
                        spacer.id = 'inbox-spacer';
                        spacer.style.height = '48px';
                        inboxList.appendChild(spacer);
                      }
                    }
                  })
                  .catch(function (err) {
                    inboxList.innerHTML =
                      '<div style="color:red;">Error loading inbox: ' +
                      err.message +
                      '</div>';
                  });
              }

              document.addEventListener('click', function (e) {});

              if (window.db) {
                loadInbox();
              } else {
                var checkDb = setInterval(function () {
                  if (window.db) {
                    clearInterval(checkDb);
                    loadInbox();
                  }
                }, 200);
              }
            });
          </script>
        </div>
      </section>
    </main>
  </body>
</html>
